var fs=require('fs');
var lines=["'use strict';","const axios = require('axios');","const db = require('./db');","const sleep = ms => new Promise(r => setTimeout(r, ms));","const UA = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36';","const baseHeaders = () => ({ 'User-Agent': UA, 'Accept': 'text/html', 'Accept-Language': 'en-US,en;q=0.9', 'Cache-Control': 'no-cache' });","async function fetchWithRetry(url, opts, retries, baseDelay) {","  retries = retries || 3; baseDelay = baseDelay || 2000;","  for (let i = 0; i < retries; i++) {","    try { return await axios.get(url, Object.assign({ headers: baseHeaders(), timeout: 15000 }, opts || {})); }","    catch (err) {","      const st = err.response && err.response.status;","      if (st === 403 || st === 401) throw err;","      if (i < retries - 1) await sleep(baseDelay * Math.pow(2, i) + Math.random() * 1000);","      else throw err;","    }","  }","}","function insertLead(lead) {","  return new Promise(function(resolve) {","    db.run('INSERT OR IGNORE INTO leads (name,contact,source,message,business,location,title,url) VALUES (?,?,?,?,?,?,?,?)',","      [lead.name,lead.contact,lead.source,lead.message||'',lead.business||'',lead.location||'',lead.title||'',lead.url||lead.contact],","      function(err) { resolve(err ? 0 : this.changes); });","  });","}","function parseTag(xml, tag) {","  const o = '<' + tag + '>'; const c = '</' + tag + '>';","  const oi = xml.indexOf(o); if (oi === -1) return '';","  let inner = xml.substring(oi + o.length, xml.indexOf(c, oi));","  if (inner.indexOf('CDATA[') > -1) inner = inner.split('CDATA[')[1].split(']]>')[0];","  return inner.trim();","}","function stripHtml(s) { let o='',t=false; for(let i=0;i<s.length;i++){if(s[i]==='<'){t=true;continue;}if(s[i]==='>'){t=false;continue;}if(!t)o+=s[i];} return o; }","const RC = [","  {sub:'Charlotte',kw:['custom','silver','gold','cast','jewelry','metal','3d print','ring','pendant','trophy','bronze','maker']},","  {sub:'CLT',kw:['custom','silver','gold','cast','jewelry','ring','bronze']},","  {sub:'Concord_NC',kw:['custom','jewelry','metal','cast','silver','gold']},","  {sub:'LakeNorman',kw:['custom','jewelry','metal','cast','silver','gold']},","  {sub:'jewelry',kw:['custom','cast','silver','gold','ring','pendant','lost wax','3d print']},","  {sub:'jewelrymaking',kw:['cast','silver','gold','custom','3d print','wax','investment','burnout']},","  {sub:'metalworking',kw:['cast','custom','silver','gold','bronze','aluminum','pewter']},","  {sub:'silversmithing',kw:['cast','custom','lost wax','investment','3d print']},","  {sub:'3Dprinting',kw:['cast','metal','silver','gold','bronze','lost resin','burnout']},","  {sub:'resinprinting',kw:['cast','metal','silver','gold','burnout']},","  {sub:'PrintedMinis',kw:['cast','metal','silver','bronze','pewter','custom']},","  {sub:'DnD',kw:['cast','metal','silver','bronze','pewter','mini','figurine','custom','trophy']},","  {sub:'DnDminiatures',kw:['cast','metal','silver','bronze','pewter','custom']},","  {sub:'DIY',kw:['custom part','cast','metal','replacement','silver','bronze','brass']},","  {sub:'HomeImprovement',kw:['custom part','cast','metal','replacement','bronze','brass']},","  {sub:'homeowners',kw:['custom','metal','cast','replacement part','bronze','brass']},","  {sub:'Gifts',kw:['custom','silver','gold','cast','metal','ring','pendant','trophy','award']},","  {sub:'Entrepreneur',kw:['custom','casting','prototype','metal','bronze','silver','contract']},","  {sub:'smallbusiness',kw:['custom','casting','prototype','metal','badge','award','trophy']},","  {sub:'Crypto',kw:['silver','gold','cold wallet','hardware wallet','tangem','ledger','precious metal']},","  {sub:'Bitcoin',kw:['silver','gold','physical','coin','cold wallet','precious metal','cast']},","  {sub:'Warhammer40k',kw:['cast','metal','figurine','mini','pewter','custom']},","];","async function scrapeReddit(business) {","  business = business || 'forgeborn';","  let total = 0;","  for (let i = 0; i < RC.length; i++) {","    const cfg = RC[i];","    try {","      await sleep(1200 + Math.random() * 800);","      const url = 'https://www.reddit.com/r/' + cfg.sub + '/new.json?limit=50';","      const resp = await fetchWithRetry(url, {headers:{'User-Agent':'LeadBot/1.0','Accept':'application/json'}});","      const posts = (resp.data && resp.data.data && resp.data.data.children) || [];","      for (let j = 0; j < posts.length; j++) {","        const p = posts[j].data;","        const text = (p.title + ' ' + (p.selftext || '')).toLowerCase();","        if (!cfg.kw.some(k => text.indexOf(k) !== -1)) continue;","        total += await insertLead({name:p.author,contact:'https://reddit.com'+p.permalink,url:'https://reddit.com'+p.permalink,source:'Reddit r/'+cfg.sub,title:p.title,message:(p.selftext||p.title).substring(0,500),business:business,location:''});","      }","    } catch(e) { console.error('Reddit r/'+cfg.sub+' err:',(e.response&&e.response.status)||e.message); }","  }","  console.log('Reddit: '+total); return total;","}","const CL = [","  {url:'https://charlotte.craigslist.org/search/bap?query=custom+jewelry&format=rss',source:'Craigslist'},","  {url:'https://charlotte.craigslist.org/search/bap?query=custom+ring&format=rss',source:'Craigslist'},","  {url:'https://charlotte.craigslist.org/search/bap?query=metal+casting&format=rss',source:'Craigslist'},","  {url:'https://charlotte.craigslist.org/search/bap?query=silversmith&format=rss',source:'Craigslist'},","  {url:'https://charlotte.craigslist.org/search/lbg?query=jewelry+custom&format=rss',source:'Craigslist'},","  {url:'https://charlotte.craigslist.org/search/lbg?query=metalwork&format=rss',source:'Craigslist'},","];","async function scrapeCraigslist(business) {","  business = business || 'forgeborn'; let total = 0;","  for (let i = 0; i < CL.length; i++) {","    const s = CL[i];","    try {","      await sleep(2000 + Math.random() * 1500);","      const resp = await fetchWithRetry(s.url, {responseType:'text'});","      const xml = resp.data || '';","      const parts = xml.split('<item>');","      for (let pi = 1; pi < parts.length; pi++) {","        const ci = parts[pi].indexOf('</' + 'item>');","        const item = ci > -1 ? parts[pi].substring(0, ci) : parts[pi];","        const title = parseTag(item, 'title');","        const link = parseTag(item, 'link');","        const desc = stripHtml(parseTag(item, 'description')).substring(0, 500);","        if (!link || !title) continue;","        total += await insertLead({name:'Craigslist Post',contact:link,url:link,source:s.source,title:title,message:desc,business:business,location:'Charlotte, NC'});","      }","    } catch(e) { console.error('Craigslist err:',(e.response&&e.response.status)||e.message); }","  }","  console.log('Craigslist: '+total); return total;","}","async function ddgSearch(query, max) {","  max = max || 8; await sleep(3000 + Math.random() * 2000);","  try {","    const resp = await fetchWithRetry('https://html.duckduckgo.com/html/', {headers:Object.assign(baseHeaders(),{'Referer':'https://duckduckgo.com/'}),params:{q:query,kl:'us-en'},responseType:'text'});","    const html = resp.data || ''; const results = []; const anchor = 'class=\"result__a\"'; let pos = 0;","    while (results.length < max) {","      const idx = html.indexOf(anchor, pos); if (idx === -1) break;","      const hs = html.indexOf('href=\"', idx) + 6; const he = html.indexOf('\"', hs);","      const te = html.indexOf('>', idx); const ct = html.indexOf('</' + 'a>', te);","      const href = html.substring(hs, he);","      const title = html.substring(te+1, ct).replace(/<[^>]+>/g,'').trim();","      const clean = href.indexOf('/l/?uddg=')===0 ? decodeURIComponent(href.replace('/l/?uddg=','').split('&')[0]) : href;","      if (clean.indexOf('http')===0 && title) results.push({url:clean,title:title});","      pos = ct + 1;","    }","    return results;","  } catch(e) { console.error('DDG err:',(e.response&&e.response.status)||e.message); return []; }","}","const DQ = [","  {q:'site:reddit.com Charlotte NC looking for custom jewelry casting silver',src:'Search/DDG'},","  {q:'site:reddit.com custom casting jewelry silver gold 3d print 2026',src:'Search/DDG'},","  {q:'site:facebook.com Charlotte custom jewelry casting silversmith',src:'Facebook/Search'},","  {q:'site:yelp.com charlotte nc jewelry casting custom silver',src:'Yelp/Search'},","  {q:'site:bbb.org charlotte nc jewelry casting silversmith',src:'BBB'},","  {q:'site:thumbtack.com charlotte nc silversmith custom jewelry',src:'Thumbtack'},","  {q:'charlotte nc looking for silversmith custom jewelry metal casting 2026',src:'Search/DDG'},","  {q:'charlotte custom trophy award silver bronze made to order',src:'Search/DDG'},","  {q:'tabletop metal miniature pewter custom commission 2026',src:'Search/DDG'},","];","async function scrapeSearch(business) {","  business = business || 'forgeborn'; let total = 0;","  for (let i = 0; i < DQ.length; i++) {","    try {","      const results = await ddgSearch(DQ[i].q, 8);","      for (let j = 0; j < results.length; j++) {","        const r = results[j];","        if (r.url.indexOf('.gov')!==-1 || r.url.indexOf('wikipedia')!==-1) continue;","        total += await insertLead({name:'Web Lead',contact:r.url,url:r.url,source:DQ[i].src,title:r.title,message:'Found via: '+DQ[i].q.substring(0,80),business:business,location:'Charlotte, NC'});","      }","    } catch(e) { console.error('Search err:',e.message); }","  }","  console.log('Search/DDG: '+total); return total;","}","async function scrapeAll(business) {","  business = business || 'forgeborn';","  console.log('Starting full scrape...');","  const reddit = await scrapeReddit(business);","  const craigslist = await scrapeCraigslist(business);","  const search = await scrapeSearch(business);","  const result = {reddit,craigslist,facebook:0,nextdoor:0,googlemaps:0,yelp:0,other:search};","  console.log('Scrape done! New leads: '+Object.values(result).reduce((a,b)=>a+b,0));","  return result;","}","module.exports = {scrapeAll,scrapeReddit,scrapeCraigslist,scrapeSearch};"];
fs.writeFileSync('scraper.js',lines.join('\n'),'utf8');
console.log('Done! Lines:',lines.length);
